<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ISL Debug Page</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .info { background-color: #d1ecf1; color: #0c5460; }
    pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
    .video-container { display: flex; gap: 20px; margin: 20px 0; }
    .video-panel { flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .prediction-box { position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.8); color: white; padding: 15px; border-radius: 8px; font-family: Arial, sans-serif; max-width: 300px; z-index: 10; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.1/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.1/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.1/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.1/holistic.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <h1>ISL Debug Page</h1>
    
    <div class="debug-section">
      <h3>Backend Status</h3>
      <button onclick="checkBackend()">Check Backend</button>
      <div id="backendStatus"></div>
    </div>

    <div class="debug-section">
      <h3>MediaPipe Detection</h3>
      <button onclick="startDetection()">Start Detection</button>
      <button onclick="stopDetection()">Stop Detection</button>
      <div id="detectionStatus"></div>
    </div>

    <div class="debug-section">
      <h3>Live Feed</h3>
      <div class="video-container">
        <div class="video-panel">
          <h4>Raw Video</h4>
          <video id="video" width="320" height="240"></video>
        </div>
        <div class="video-panel">
          <h4>MediaPipe Output</h4>
          <canvas id="canvas" width="320" height="240"></canvas>
          <div id="predictionBox" class="prediction-box" style="display: none;">
            <div id="predictionText">Ready...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="debug-section">
      <h3>Debug Log</h3>
      <button onclick="clearLog()">Clear Log</button>
      <pre id="debugLog"></pre>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8000';
    let holistic = null;
    let camera = null;
    let isDetecting = false;

    function log(message) {
      const debugLog = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      debugLog.textContent += `[${timestamp}] ${message}\n`;
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('debugLog').textContent = '';
    }

    async function checkBackend() {
      const statusDiv = document.getElementById('backendStatus');
      try {
        log('Checking backend connection...');
        const response = await fetch(`${API_BASE_URL}/`);
        const data = await response.json();
        
        statusDiv.innerHTML = `
          <div class="status success">
            <strong>Backend Connected!</strong><br>
            Status: ${data.status}<br>
            Model Loaded: ${data.model_loaded ? 'Yes' : 'No'}
          </div>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        
        log(`Backend status: ${data.status}, Model loaded: ${data.model_loaded}`);
        
        if (data.model_loaded) {
          // Test prediction
          log('Testing prediction with dummy data...');
          const dummyKeypoints = Array(54).fill(0.1);
          const testResponse = await fetch(`${API_BASE_URL}/predict`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keypoints: dummyKeypoints, num_frames: 1 })
          });
          const testData = await testResponse.json();
          log(`Test prediction: ${testData.prediction} (${(testData.confidence * 100).toFixed(1)}%)`);
        }
        
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="status error">
            <strong>Backend Connection Failed!</strong><br>
            Error: ${error.message}
          </div>
        `;
        log(`Backend error: ${error.message}`);
      }
    }

    function startDetection() {
      if (isDetecting) return;
      
      log('Starting MediaPipe detection...');
      isDetecting = true;
      
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      holistic = new Holistic({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.1/${file}`;
        }
      });

      holistic.onResults((results) => {
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
        
        // Draw pose landmarks
        if (results.poseLandmarks) {
          drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00'});
          drawLandmarks(ctx, results.poseLandmarks, {color: '#00FF00', fillColor: '#FF0000'});
          
          // Extract keypoints and test prediction
          extractAndTestKeypoints(results);
        }
        
        ctx.restore();
      });

      camera = new Camera(video, {
        onFrame: async () => {
          await holistic.send({image: video});
        },
        width: 320,
        height: 240
      });
      
      camera.start();
      document.getElementById('detectionStatus').innerHTML = '<div class="status success">Detection started</div>';
      log('MediaPipe detection started');
    }

    function stopDetection() {
      if (!isDetecting) return;
      
      if (camera) {
        camera.stop();
      }
      isDetecting = false;
      document.getElementById('detectionStatus').innerHTML = '<div class="status info">Detection stopped</div>';
      log('MediaPipe detection stopped');
    }

    function extractAndTestKeypoints(results) {
      if (!results.poseLandmarks || results.poseLandmarks.length < 33) {
        return;
      }
      
      const keypoints = [];
      
      // Extract first 18 landmarks (54 features total)
      for (let i = 0; i < 18; i++) {
        if (results.poseLandmarks[i] && results.poseLandmarks[i].visibility > 0.3) {
          const lm = results.poseLandmarks[i];
          keypoints.push(lm.x, lm.y, lm.z || 0);
        } else {
          keypoints.push(0, 0, 0);
        }
      }
      
      // Test prediction every 2 seconds
      if (Date.now() % 2000 < 100) { // Rough 2-second interval
        testPrediction(keypoints);
      }
    }

    async function testPrediction(keypoints) {
      try {
        const response = await fetch(`${API_BASE_URL}/predict`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keypoints: keypoints, num_frames: 1 })
        });
        
        const data = await response.json();
        
        if (data.prediction && data.confidence > 0.05) {
          document.getElementById('predictionText').textContent = 
            `${data.prediction} (${(data.confidence * 100).toFixed(1)}%)`;
          document.getElementById('predictionBox').style.display = 'block';
          log(`Prediction: ${data.prediction} (${(data.confidence * 100).toFixed(1)}%)`);
        } else {
          document.getElementById('predictionBox').style.display = 'none';
        }
        
      } catch (error) {
        log(`Prediction error: ${error.message}`);
      }
    }

    // Auto-check backend on load
    window.addEventListener('load', () => {
      setTimeout(checkBackend, 1000);
    });
  </script>
</body>
</html>
